<!DOCTYPE html>
<html lang="en">
<!-- <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pariksha Setu - Student Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        .hide { display: none !important; }
        .card-custom { border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: none; background: white; }
        .option-div { border: 2px solid #eaecf4; padding: 15px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; background: white; }
        .option-div:hover { border-color: #4e73df; background-color: #f8f9fc; }
        .option-div.selected { background-color: #4e73df; color: white; border-color: #4e73df; }
        .q-palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .q-node { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; background: #e3e6f0; color: #5a5c69; }
        .q-node.active { border: 2px solid #4e73df; }
        .q-node.attempted { background: #1cc88a; color: white; }
        .q-node.current { background: #4e73df; color: white; }
        .correct-ans { background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; }
        .wrong-ans { background-color: #f8d7da; border-color: #f5c2c7; color: #842029; }
        #antiCheatOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        
        /* Chat Styles - Responsive Update */
        .chat-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #4e73df; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .chat-box { position: fixed; bottom: 90px; right: 20px; width: 350px; height: 450px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { background: #4e73df; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fc; }
        .chat-footer { padding: 10px; border-top: 1px solid #eee; background: white; display: flex; gap: 5px; }
        .msg { padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; font-size: 14px; }
        .msg.me { background: #4e73df; color: white; align-self: flex-end; margin-left: auto; }
        .msg.admin { background: #e3e6f0; color: #333; align-self: flex-start; }

        .date-input-wrapper { position: relative; }
        .date-input-wrapper label { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; transition: 0.2s; font-size: 1rem; z-index: 2; }
        .date-input-wrapper input[type="date"] { position: relative; z-index: 1; background-color: transparent !important; color: transparent; }
        .date-input-wrapper input[type="date"]:focus { background-color: white !important; }
        .date-input-wrapper input[type="date"]:focus + label,
        .date-input-wrapper input[type="date"].has-value + label { opacity: 0; }
        .date-input-wrapper input[type="date"].has-value { background-color: white !important; color: #212529 !important; }
        .date-input-wrapper input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; z-index: 3; position: relative; }
        
        @media (max-width: 768px) { 
            .nav-pills { flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; } 
            .nav-pills::-webkit-scrollbar { display: none; }
            /* Chat responsive fix */
            .chat-box { right: 0; left: 0; bottom: 0; top: 0; width: 100%; height: 100%; border-radius: 0; z-index: 10000; }
            .chat-btn { z-index: 10001; }
        }
    </style>
</head> -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pariksha Setu - Student Portal</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- MODERN VARIABLES --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.18);
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --accent-color: #764ba2;
        }

        /* --- GLOBAL STYLES --- */
        body {
            background: var(--primary-gradient); /* Vibrant Gradient Background */
            font-family: 'Poppins', sans-serif; /* Modern Font */
            color: #2d3748;
            min-height: 100vh;
            user-select: none;
        }

        .hide { display: none !important; }

        /* --- GLASSMORPHISM CARDS --- */
        .card-custom {
            background: var(--glass-bg);
            backdrop-filter: blur(8px); /* Frosted Glass Effect */
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px; /* More rounded corners */
            border: var(--glass-border);
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Hover effect for Exam Cards */
        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.25);
        }

        /* --- INPUTS & FORMS --- */
        .form-control {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        .form-control:focus {
            background: white;
            box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.2); /* Purple Glow */
            border-color: var(--accent-color);
        }

        /* --- MODERN BUTTONS --- */
        .btn {
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-success, .btn-primary {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }
        .btn-success:hover, .btn-primary:hover {
            background: linear-gradient(90deg, #5a67d8 0%, #6b46c1 100%);
            box-shadow: 0 6px 20px rgba(118, 75, 162, 0.4);
            transform: translateY(-2px);
        }

        /* Secondary button effects (keeping original color) */
        .btn-secondary {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary:hover {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        /* --- NAVIGATION TABS --- */
        .nav-pills {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px;
            border-radius: 15px;
            margin-bottom: 25px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        .nav-pills .nav-link {
            color: white;
            border-radius: 12px;
            margin: 0 5px;
            font-weight: 500;
            padding: 10px 20px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .nav-pills .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .nav-pills .nav-link.active {
            background: white;
            color: var(--accent-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-weight: 700;
        }

        /* --- EXAM QUESTION STYLES --- */
        .option-div {
            border: 2px solid #e2e8f0;
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            font-weight: 500;
        }
        .option-div:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        .option-div.selected {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.2);
        }

        /* --- CORRECT & WRONG ANSWERS --- */
        .correct-ans { background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; }
        .wrong-ans { background-color: #f8d7da; border-color: #f5c2c7; color: #842029; }

        /* --- VIEW PAPER BUTTON --- */
        button[onclick*="viewPaper"] {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.25);
        }
        button[onclick*="viewPaper"]:hover {
            background: linear-gradient(90deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(118, 75, 162, 0.35);
            color: white;
        }

        /* --- PALETTE & NODES --- */
        .q-node {
            width: 40px; height: 40px;
            border-radius: 12px; /* Soft square */
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; cursor: pointer;
            background: #edf2f7; color: #718096;
            transition: all 0.2s;
        }
        .q-node.current {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }
        .q-node.attempted {
            background: #48bb78;
            color: white;
        }

        /* --- ANTI-CHEAT OVERLAY --- */
        #antiCheatOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }

        /* --- LOADING OVERLAY --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .spinner-modern {
            width: 50px; height: 50px;
            border: 5px solid #e3e6f0;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CHAT BUBBLE (Modern) --- */
        .chat-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: #7e66ea; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; }
        .chat-box { position: fixed; bottom: 90px; right: 20px; width: 350px; height: 450px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { background: #764ba2; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fc; }
        .chat-footer { padding: 10px; border-top: 1px solid #eee; background: white; display: flex; gap: 5px; }
        .msg { padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; font-size: 14px; }
        .msg.me { background: #764ba2; color: white; align-self: flex-end; margin-left: auto; }
        .msg.admin { background: #e3e6f0; color: #333; align-self: flex-start; }
        
        /* --- EMPTY STATE MESSAGES --- */
        .text-muted { color: white !important; } /* Softer gray for empty state messages */

        /* --- DATE INPUT FIX --- */
        .date-input-wrapper { position: relative; }
        .date-input-wrapper label { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; transition: 0.2s; font-size: 0.95rem; }
        .date-input-wrapper input:focus + label,
        .date-input-wrapper input.has-value + label { opacity: 0; }

        /* Responsive */
        @media (max-width: 768px) {
            .card-custom { padding: 1.5rem !important; }
        }
    </style>
</head>

<body oncontextmenu="return false" oncopy="return false" oncut="return false" onpaste="return false">

    <div id="loginLoader" class="loading-overlay hide">
        <div class="spinner-modern"></div>
        <h5 class="fw-bold" style="color: var(--accent-color);">Logging In...</h5>
    </div>

    <div id="antiCheatOverlay" class="hide">
        <h2 class="text-danger fw-bold">SECURITY VIOLATION</h2>
        <p id="overlayMsg">Secure mode exited. You must re-enter fullscreen to continue.</p>
        <button onclick="enterSecureMode()" class="btn btn-primary btn-lg">Resume Exam</button>
    </div>

    <div class="container mt-5" id="authSection">
        <div class="row justify-content-center">
            <div class="col-md-5 col-12">
                <div class="card card-custom p-4 p-md-5">
                    <div class="text-center mb-4">
                        <i class="fa-duotone fa-solid fa-graduation-cap fa-3x mb-2"></i>
                        <h2 class="fw-bold">PARIKSHA SETU</h2>
                        <h3 class="fw-bold" style="color: #764ba2;">Student Login</h3>
                    </div>
                    <form id="formStudentLogin">
                        <input type="text" id="sBrand" class="form-control mb-3" placeholder="School Code" required>
                        <input type="text" id="sId" class="form-control mb-3" placeholder="Student ID" required>
                        <div class="date-input-wrapper">
                            <input type="date" id="sDob" class="form-control mb-3" required>
                            <label for="sDob">Date of Birth</label>
                        </div>
                        <button class="btn btn-success w-100 mb-3">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-2 mt-md-4 hide" id="studentPanel">
        <div class="row mb-4" id="navHeader">
            <div class="col-12">
                <div class="card card-custom p-3 d-flex flex-row justify-content-between align-items-center">
                    <div><span class="fw-bold" id="pName">Student</span> <br class="d-md-none"><small>Class: <span id="pClass"></span> | ID: <span id="pId"></span></small></div>
                    <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
                </div>
            </div>
        </div>

        <ul class="nav nav-pills mb-3" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" onclick="tab('ongoing', this)">Ongoing</button></li>
            <li class="nav-item"><button class="nav-link" onclick="tab('upcoming', this)">Upcoming</button></li>
            <li class="nav-item"><button class="nav-link" onclick="tab('finished', this)">Finished</button></li>
            <li class="nav-item"><button class="nav-link" onclick="tab('missed', this)">Missed</button></li>
            <li class="nav-item"><button class="nav-link" onclick="tab('results', this)">Results & Rank</button></li>
        </ul>

        <div id="view-ongoing" class="s-view"><div id="ongoingList" class="row"></div></div>
        <div id="view-upcoming" class="s-view hide"><div id="upcomingList" class="row"></div></div>
        <div id="view-finished" class="s-view hide"><div id="finishedList" class="row"></div></div>
        <div id="view-missed" class="s-view hide"><div id="missedList" class="row"></div></div>
        <div id="view-results" class="s-view hide">
            <div id="myResultsList" class="row"></div>
        </div>

        <div class="modal fade" id="viewPaperModal" tabindex="-1">
            <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Answer Sheet</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="viewPaperBody"></div></div></div>
        </div>

        <div id="instructionScreen" class="hide">
            <div class="card card-custom p-4 p-md-5">
                <h3 class="fw-bold mb-3" id="instTitle">Exam Instructions</h3>
                <div class="alert alert-danger"><b>Anti-Cheat:</b> Fullscreen is mandatory. 3 strikes result in auto-submission. Single attempt only.</div>
                <div class="p-3 bg-light rounded border mb-4" id="instText" style="white-space: pre-wrap;"></div>
                <div class="text-center">
                    <h5 id="instTimerMsg" class="text-danger mb-3">Please wait...</h5>
                    <h2 id="instTimer" class="fw-bold mb-4">00:00</h2>
                    <button id="btnContinue" disabled onclick="enterSecureMode()" class="btn btn-primary btn-lg px-5">Continue to Exam</button>
                </div>
            </div>
        </div>

        <div id="examInterface" class="hide">
            <div class="row">
                <div class="col-md-9 order-2 order-md-1">
                    <div class="card card-custom p-4">
                        <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                            <h5 class="fw-bold" id="examSubject">Subject</h5>
                            <div class="text-danger fw-bold fs-5"><i class="fas fa-clock"></i> <span id="mainTimer">00:00:00</span></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="badge bg-secondary">Q <span id="qNum">1</span></span>
                            <span class="badge bg-info text-dark">Marks: <span id="qMarks">1</span></span>
                        </div>
                        <h5 id="qTextDisplay" class="mb-4 lh-base">Q</h5>
                        <div id="qOptionsDisplay"></div>
                        <div class="d-flex justify-content-between mt-5">
                            <button onclick="prevQ()" class="btn btn-secondary px-4" id="btnPrev">Previous</button>
                            <button onclick="nextQ()" class="btn btn-primary px-4" id="btnNext">Next</button>
                            <button onclick="submitExam()" class="btn btn-success px-4 hide" id="btnFinish">Finish Exam</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 order-1 order-md-2 mb-3 mb-md-0">
                    <div class="card card-custom p-3 text-center">
                        <h6 class="border-bottom pb-2 mb-3">Palette</h6>
                        <div class="q-palette-grid" id="qPalette"></div>
                        <hr>
                        <div class="text-danger small fw-bold">Strikes: <span id="strikeCount">0</span>/3</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat UI -->
        <div id="chatBtn" class="chat-btn" onclick="toggleChat()"><i class="fas fa-headset"></i></div>
        <div class="chat-box hide" id="chatBox">
            <div class="chat-header">
                <span>Support & Issues</span>
                <button class="btn-close btn-close-white" onclick="toggleChat()"></button>
            </div>
            <div class="chat-body" id="chatBody"></div>
            <div class="chat-footer">
                <input type="text" id="chatInput" class="form-control form-control-sm" placeholder="Type a message...">
                <button onclick="sendMsg()" class="btn btn-primary btn-sm"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const CONFIG = { apiKey: "AIzaSyAqtiKQxosFVTH7ebkg20KgqZUuNxTmkq8",
        authDomain: "online-pariksha-setu.firebaseapp.com",
        projectId: "online-pariksha-setu",
        storageBucket: "online-pariksha-setu.firebasestorage.app",
        messagingSenderId: "860951509346",
        appId: "1:860951509346:web:cc61614df155bf54ae143b",
        measurementId: "G-P3DETPX0C1" };
        const app = initializeApp(CONFIG);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db; window.user = null;
        let examData = { details:null, questions:[], answers:[], idx:0, timerInterval:null, attemptStartTime: null };
        let instInterval = null, isExamActive = false, strikes = 0;
        let globalExams = [], globalResults = [];
        let chatUnsub = null, currentTicketId = null;

        // Anti-Cheat: Keys & Visibility
        document.addEventListener('keydown', e => {
            if (!isExamActive) return;
            if (e.key === "PrintScreen" || e.key === "F12" || (e.ctrlKey && ['c','v','u','s','i'].includes(e.key.toLowerCase()))) {
                e.preventDefault(); alert("Action Restricted.");
            }
        });

        document.addEventListener('visibilitychange', () => { 
            if (isExamActive && document.visibilityState === 'hidden') registerStrike("Tab Switch Detected");
        });

        document.addEventListener('fullscreenchange', () => { 
            if (isExamActive && !document.fullscreenElement) { 
                document.getElementById('antiCheatOverlay').classList.remove('hide'); 
                registerStrike("Fullscreen Exit Detected");
            }
        });

        function registerStrike(reason) {
            strikes++;
            document.getElementById('strikeCount').innerText = strikes;
            if (strikes >= 3) submitExam(true, "Auto-submitted: 3 security strikes.");
            else alert(`Warning ${strikes}/3: ${reason}`);
        }

        window.enterSecureMode = async () => {
            try { 
                await document.documentElement.requestFullscreen(); 
                document.getElementById('antiCheatOverlay').classList.add('hide'); 
                if (!isExamActive) startActualExam(); 
            } catch (err) { alert("Fullscreen required."); }
        };

        // Handle date input label visibility
        const dobInput = document.getElementById('sDob');
        function updateDobLabel() {
            if (dobInput.value) {
                dobInput.classList.add('has-value');
                dobInput.style.color = '#212529';
            } else {
                dobInput.classList.remove('has-value');
                dobInput.style.color = 'transparent';
            }
        }
        dobInput.addEventListener('change', updateDobLabel);
        dobInput.addEventListener('input', updateDobLabel);
        dobInput.addEventListener('focus', function() {
            this.style.backgroundColor = 'white';
            if (!this.value) {
                this.style.color = 'transparent';
            }
        });
        dobInput.addEventListener('blur', function() {
            if (!this.value) {
                this.style.backgroundColor = 'transparent';
                this.style.color = 'transparent';
            }
        });
        // Initialize on page load
        updateDobLabel();

        document.getElementById('formStudentLogin').onsubmit = async (e) => {
            e.preventDefault();
            const loader = document.getElementById('loginLoader');
            loader.classList.remove('hide');

            try {
                const brand = document.getElementById('sBrand').value.trim();
                const id = document.getElementById('sId').value.trim();
                const dob = document.getElementById('sDob').value;
                const snap = await getDocs(query(collection(db, 'students'), where('brand','==',brand), where('id','==',id), where('dob','==',dob)));
                
                if(snap.empty) {
                    loader.classList.add('hide');
                    return Swal.fire('Wrong Credentials','Invalid Login','error');
                }
                const d = snap.docs[0]; const data = d.data();
                if(data.blocked) {
                    loader.classList.add('hide');
                    return Swal.fire('Blocked','Contact Admin','error');
                }
                const sess = crypto.randomUUID();
                await updateDoc(doc(db, 'students', d.id), { sessionId: sess });
                localStorage.setItem('mvmn_session', sess);
                window.user = { docId: d.id, data: data };
                initDashboard();
                loader.classList.add('hide');
            } catch (err) {
                console.error(err);
                loader.classList.add('hide');
                Swal.fire('Error', 'Login Failed', 'error');
            }
        };

        const initDashboard = () => {
            document.getElementById('authSection').classList.add('hide');
            document.getElementById('studentPanel').classList.remove('hide');
            onSnapshot(doc(db, 'students', window.user.docId), (d) => {
                if(!d.exists()) { location.reload(); return; }
                const f = d.data();
                if(f.blocked || f.sessionId !== localStorage.getItem('mvmn_session')) { location.reload(); return; }
                document.getElementById('pName').innerText = f.name;
                document.getElementById('pClass').innerText = f.class;
                document.getElementById('pId').innerText = f.id;
                window.user.data = f;
                setupListeners();
                initChat();
            });
            setInterval(renderExams, 10000);
        };

        window.tab = (t, el) => {
            document.querySelectorAll('.s-view').forEach(v => v.classList.add('hide'));
            document.getElementById('view-'+t).classList.remove('hide');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('instructionScreen').classList.add('hide');
            document.getElementById('examInterface').classList.add('hide');
            document.getElementById('mainTabs').classList.remove('hide');
        };

        const setupListeners = () => {
            onSnapshot(query(collection(db, 'exams'), where('brand','==',window.user.data.brand), where('class','==',window.user.data.class)), (snap) => {
                globalExams = snap.docs.map(d=>({id:d.id, ...d.data()}));
                renderExams();
            });
            onSnapshot(query(collection(db,'results'), where('studentId','==',window.user.data.id)), (snap) => {
                globalResults = snap.docs.map(d=>d.data());
                renderExams();
            });
        };

        const renderExams = async () => {
            const now = new Date();
            let ongoing=[], upcoming=[], finished=[], missed=[];
            
            const allResSnap = await getDocs(query(collection(db, 'results'), where('brand', '==', window.user.data.brand)));
            const allResults = allResSnap.docs.map(d => d.data());

            globalExams.forEach(e => {
                const isFinished = globalResults.find(r => r.examId === e.id);
                if(isFinished) { finished.push(e); return; }

                // Check for individual special schedule overrides
                let start = e.startTime ? new Date(e.startTime) : null;
                let end = e.endTime ? new Date(e.endTime) : null;

                // Handle specialSchedules Map override
                if (e.specialSchedules && e.specialSchedules[window.user.data.id]) {
                    start = new Date(e.specialSchedules[window.user.data.id].start);
                    end = new Date(e.specialSchedules[window.user.data.id].end);
                }

                if(!start || !end) return;

                const buffer = new Date(start.getTime() - 60000); 

                if(now > end) missed.push(e);
                else if(now >= buffer) ongoing.push(e);
                else upcoming.push(e);
            });

            const renderCard = (e, btn) => `<div class="col-md-6 mb-3"><div class="card p-3 shadow-sm"><h5>${e.title}</h5><p>${new Date(e.startTime).toLocaleString()} - ${new Date(e.endTime).toLocaleTimeString()}</p>${btn}</div></div>`;

            document.getElementById('ongoingList').innerHTML = ongoing.length ? ongoing.map(e => renderCard(e, `<button onclick="startInstructions('${e.id}')" class="btn btn-success w-100">Start Exam</button>`)).join('') : '<p class="p-3 text-muted">No exams active.</p>';
            document.getElementById('upcomingList').innerHTML = upcoming.length ? upcoming.map(e => renderCard(e, `<button disabled class="btn btn-secondary w-100">Wait</button>`)).join('') : '<p class="p-3 text-muted">No upcoming exams.</p>';
            document.getElementById('finishedList').innerHTML = finished.length ? finished.map(e => renderCard(e, `<span class="badge bg-success">Completed</span>`)).join('') : '<p class="p-3 text-muted">No finished exams.</p>';
            document.getElementById('missedList').innerHTML = missed.length ? missed.map(e => renderCard(e, `<span class="badge bg-danger">Missed</span>`)).join('') : '<p class="p-3 text-muted">No missed exams.</p>';

            const showRes = globalResults.filter(r => { const ex = globalExams.find(e=>e.id===r.examId); return ex && ex.resultDeclared; });
            document.getElementById('myResultsList').innerHTML = showRes.length ? showRes.map(r => {
                const examResults = allResults.filter(ar => ar.examId === r.examId).sort((a,b) => b.score - a.score);
                const rank = examResults.findIndex(er => er.studentId === window.user.data.id) + 1;
                return `<div class="col-md-4 mb-3">
                    <div class="card p-3 border-primary border-top border-4 shadow-sm text-center">
                        <h5>${r.examTitle}</h5>
                        <h2 class="text-primary">${r.score}/${r.total}</h2>
                        <div class="badge bg-primary mb-2">Rank #${rank}</div><br>
                        <button onclick="viewPaper('${r.examId}')" class="btn btn-sm btn-outline-primary mt-2">View Paper</button>
                    </div>
                </div>`;
            }).join('') : '<p class="p-3 text-muted">Results are not yet declared.</p>';
        };

        window.viewPaper = async (eid) => {
            const r = globalResults.find(res => res.examId === eid);
            const qSnap = await getDocs(query(collection(db,'questions'), where('examId','==',eid)));
            // FIX: Map document ID so detailedAnswers[q.id] works
            const questions = qSnap.docs.map(d => ({id: d.id, ...d.data()})); 
            const timeStr = r.timeTaken ? `${Math.floor(r.timeTaken / 60)}m ${r.timeTaken % 60}s` : 'N/A';
            let html = `<div class="text-center mb-3"><h3>Score: ${r.score} / ${r.total}</h3><p>Time Taken: ${timeStr}</p></div><hr>`;
            
            questions.forEach((q, i) => {
                let userAns = -1;
                // FIX: Check for undefined specifically to handle answer '0'
                if (r.detailedAnswers && r.detailedAnswers[q.id] !== undefined) {
                    userAns = r.detailedAnswers[q.id];
                } else if (r.answers && Array.isArray(r.answers)) {
                     userAns = r.answers[i]; 
                }
                
                const isCorrect = userAns === q.correct;
                html += `<div class="mb-3 p-3 border rounded ${isCorrect ? 'correct-ans' : 'wrong-ans'}"><strong>Q. ${q.text}</strong><br><small>Your Ans: ${userAns > -1 ? q.opts[userAns] : 'Not Answered'} ${isCorrect ? '✅' : '❌'}</small><br>${!isCorrect ? `<small class="text-success fw-bold">Correct: ${q.opts[q.correct]}</small>` : ''}</div>`;
            });
            document.getElementById('viewPaperBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('viewPaperModal')).show();
        };

        // Fisher-Yates Shuffle
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        window.startInstructions = async (id) => {
            document.getElementById('chatBtn').classList.add('hide');
            document.getElementById('chatBox').classList.add('hide');
            const eDoc = (await getDocs(query(collection(db,'exams'),where('__name__','==',id)))).docs[0];
            const qSnap = await getDocs(query(collection(db,'questions'), where('examId','==',id)));
            if(qSnap.empty) return Swal.fire('Error','Questions not ready.','error');
            
            let qs = qSnap.docs.map(d=>({id: d.id, ...d.data()}));
            qs = shuffleArray(qs);

            examData = { details: {id, ...eDoc.data()}, questions: qs, answers: new Array(qs.length).fill(null), idx: 0, attemptStartTime: null };
            document.querySelectorAll('.s-view').forEach(v => v.classList.add('hide'));
            document.getElementById('mainTabs').classList.add('hide');
            document.getElementById('instructionScreen').classList.remove('hide');
            document.getElementById('instTitle').innerText = examData.details.title;
            document.getElementById('instText').innerText = examData.details.instructions;

            let start = new Date(examData.details.startTime);
            // Override start time if special schedule exists
            if(examData.details.specialSchedules && examData.details.specialSchedules[window.user.data.id]) {
                start = new Date(examData.details.specialSchedules[window.user.data.id].start);
            }

            clearInterval(instInterval);
            instInterval = setInterval(() => {
                const diff = start - new Date();
                const isSpecial = (examData.details.specialSchedules && examData.details.specialSchedules[window.user.data.id]);
                
                if(diff <= 0 || isSpecial) {
                    clearInterval(instInterval);
                    document.getElementById('instTimerMsg').innerText = "Exam Started!";
                    document.getElementById('instTimer').innerText = "00:00";
                    document.getElementById('btnContinue').disabled = false;
                } else {
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    document.getElementById('instTimer').innerText = `00:${s < 10 ? '0'+s : s}`;
                }
            }, 1000);
        };

        window.startActualExam = () => {
            isExamActive = true; strikes = 0;
            examData.attemptStartTime = new Date(); 
            document.getElementById('instructionScreen').classList.add('hide');
            document.getElementById('examInterface').classList.remove('hide');
            document.getElementById('navHeader').classList.add('hide');
            document.getElementById('examSubject').innerText = examData.details.subject;
            renderPalette(); renderQ(); startMainTimer();
        };

        const startMainTimer = () => {
            let endTime = new Date(examData.details.endTime);
            // Override end time if special schedule exists
            if(examData.details.specialSchedules && examData.details.specialSchedules[window.user.data.id]) {
                endTime = new Date(examData.details.specialSchedules[window.user.data.id].end);
            }
            
            const durationEnd = new Date(examData.attemptStartTime.getTime() + (examData.details.duration * 60000));
            const actualEnd = new Date(Math.min(endTime, durationEnd));

            clearInterval(examData.timerInterval);
            examData.timerInterval = setInterval(() => {
                const diff = actualEnd - new Date();
                if(diff <= 0) submitExam(true);
                else {
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    document.getElementById('mainTimer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                }
            }, 1000);
        };

        const renderQ = () => {
            const q = examData.questions[examData.idx];
            document.getElementById('qNum').innerText = examData.idx + 1;
            document.getElementById('qMarks').innerText = examData.details.marksPerQ;
            document.getElementById('qTextDisplay').innerText = q.text;
            document.getElementById('qOptionsDisplay').innerHTML = q.opts.map((o,i) => `<div class="option-div ${examData.answers[examData.idx]===i?'selected':''}" onclick="setAns(${i})"><b>${String.fromCharCode(65+i)}.</b> ${o}</div>`).join('');
            
            // Fix for buttons
            const isLast = examData.idx === examData.questions.length - 1;
            document.getElementById('btnFinish').classList.toggle('hide', !isLast);
            document.getElementById('btnNext').classList.toggle('hide', isLast);
            document.getElementById('btnPrev').disabled = (examData.idx === 0);

            updatePalette();
        };

        const renderPalette = () => { document.getElementById('qPalette').innerHTML = examData.questions.map((_, i) => `<div class="q-node" id="node-${i}" onclick="jumpQ(${i})">${i+1}</div>`).join(''); };
        const updatePalette = () => { examData.questions.forEach((_, i) => { const n = document.getElementById(`node-${i}`); if(n) n.className = 'q-node' + (i === examData.idx ? ' current' : '') + (examData.answers[i] !== null ? ' attempted' : ''); }); };

        window.setAns = (i) => { examData.answers[examData.idx] = i; renderQ(); };
        window.prevQ = () => { if(examData.idx > 0) { examData.idx--; renderQ(); }};
        window.nextQ = () => { if(examData.idx < examData.questions.length-1) { examData.idx++; renderQ(); }};
        window.jumpQ = (i) => { examData.idx = i; renderQ(); };

        window.submitExam = async (auto=false, reason="") => {
            if(!auto && !confirm("Submit Exam?")) return;
            isExamActive = false; clearInterval(examData.timerInterval);
            if(document.fullscreenElement) document.exitFullscreen();
            
            let score = 0; 
            const detailedAnswers = {}; 
            
            examData.questions.forEach((q, i) => { 
                const ans = examData.answers[i];
                detailedAnswers[q.id] = ans !== null ? ans : -1;
                if(q.correct === ans) score += examData.details.marksPerQ; 
            });
            
            const total = examData.questions.length * examData.details.marksPerQ;
            const timeTaken = Math.floor((new Date() - examData.attemptStartTime) / 1000);

            await addDoc(collection(db, 'results'), { 
                brand: window.user.data.brand, studentName: window.user.data.name, studentId: window.user.data.id, 
                examId: examData.details.id, examTitle: examData.details.title, score, total, 
                answers: examData.answers.map(a=>a??-1),
                detailedAnswers,
                strikes, timeTaken, timestamp: serverTimestamp() 
            });
            Swal.fire('Completed', reason, 'success').then(() => location.reload());
        };

        // --- Chat & Support Logic ---
        window.toggleChat = () => {
            const box = document.getElementById('chatBox');
            box.classList.toggle('hide');
            if(!box.classList.contains('hide')) scrollToBottom();
        };

        const initChat = async () => {
            // FIX: Removed orderBy to avoid index requirement issues. We will sort in JS if needed (or rely on natural order for singleton)
            const q = query(collection(db, 'tickets'), where('studentId', '==', window.user.data.id), where('brand', '==', window.user.data.brand));
            
            // We only want the active one, so we fetch and filter in JS to be safe
            onSnapshot(q, (snap) => {
                 if(snap.empty) { currentTicketId = null; return; }
                 // Find most recent locally
                 const docs = snap.docs.map(d => ({id:d.id, ...d.data()}));
                 docs.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                 
                 currentTicketId = docs[0].id;
                 listenMessages(currentTicketId);
            });
        };

        window.sendMsg = async () => {
            const txt = document.getElementById('chatInput').value.trim();
            if(!txt) return;
            
            if(!currentTicketId) {
                const docRef = await addDoc(collection(db, 'tickets'), {
                    brand: window.user.data.brand,
                    studentId: window.user.data.id,
                    studentName: window.user.data.name,
                    status: 'open',
                    lastMessage: txt,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                currentTicketId = docRef.id;
            }

            await addDoc(collection(db, 'tickets', currentTicketId, 'messages'), {
                text: txt, sender: 'student', timestamp: serverTimestamp()
            });
            
            await updateDoc(doc(db, 'tickets', currentTicketId), {
                lastMessage: txt, updatedAt: serverTimestamp()
            });

            document.getElementById('chatInput').value = '';
        };

        const listenMessages = (tId) => {
            if(chatUnsub) chatUnsub();
            // Subcollections usually don't need composite indexes for simple orderBy
            chatUnsub = onSnapshot(query(collection(db, 'tickets', tId, 'messages'), orderBy('timestamp', 'asc')), snap => {
                const body = document.getElementById('chatBody');
                body.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    return `<div class="d-flex flex-column"><div class="msg ${m.sender === 'student' ? 'me' : 'admin'}">${m.text}</div><small class="text-muted" style="font-size:10px; align-self: ${m.sender==='student'?'flex-end':'flex-start'}">${m.timestamp?.toDate().toLocaleTimeString()||''}</small></div>`;
                }).join('');
                scrollToBottom();
            });
        };
        
        const scrollToBottom = () => { const d = document.getElementById('chatBody'); d.scrollTop = d.scrollHeight; };

        window.logout = () => location.reload();
        signInAnonymously(auth);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>